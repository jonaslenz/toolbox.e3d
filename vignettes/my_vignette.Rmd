---
title: "toolbox.e3d"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{toolbox.e3d}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Intro

The R wrapper package toolbox.e3d was created to perform often occuring tasks done with the soil erosion model EROSION-3D in an easy usable and reproducable way.
It requires a licenced EROSION-3D installation on a Windows system.
Download of this software and licence conditions are available at Geognostics (http://bodenerosion.com/e3d_lizenzen.html).

EROSION-3D is designed as software with Graphical User Interface (GUI) with limited command line support introduced in version 3.15.
The toolbox.e3d uses only the command line interaction, for fully reproducable work.
Each manual change in modelling is seen as non reproducable, or at least failure prone [@gmd_executive_editors_editorial_2019].

The toolbox.e3d was developed with the 32-bit EROSION-3D version 3.2.0.9.
As the command line interaction is sparesly used up to now, several functions may not work with older versions of EROSION-3D


## Command line interaction with E3D

There are three basic commands to run EROSION-3D from command line [@von_werner2007]:

 - '/c' for calculation
 - '/r' for preprocessing of relief set
 - '/s' for preprocessing of soil set (available from version 3.2.0.9)

All further options (paths to input files, modelling options) are set in a *.PAR file.

This command would run an EROSION-3D calculation from the R-environment:
```{r, eval = FALSE}
system2("e3d", '/c "C:/E3Dmodel/model/run.par"'), wait=TRUE)
```

and as pure command line call:
```{}
e3d /r C:/E3Dmodel/model/run.par
```

# Installation

Use the following commands in R to install toolbox.e3d
```{r, eval = FALSE}
# Install devtools from CRAN
install.packages("devtools")

# Install toolbox.e3d
devtools::install_github("jonaslenz/toolbox.e3d")
```

EROSION-3D needs to be installed and licencesed separetely, please refer to the handbook [@von_werner].

## test setup

Once EROSION-3D is installed and activated the interaction with toolbox.e3d can be tested using

```{r}
toolbox.e3d::get_version.E3D()
```

This function checks, if EROSION-3D can be found in the system PATH-Variable.
If it is not present in PATH it searchs for EROSION-3D in the registry and adds it temporarely to PATH for the current R-session.

If this function fails with error message "cannot access e3d instalation" you should check the installtion of EROSION-3D and add the installation folder manually to system PATH.

When succesful this function runs an elevation model preprocessing and returns the version number in the created file relief.log.

To get full build information use
```{r, eval = FALSE}
toolbox.e3d::get_version.E3D(build = T)
```


# determination of calibration parameters Skinfactor and resistance to erosion

Soil input parameters of EROSION-3D include the two calibration parameters skinfactor and resistance to erosion.
Determination of these two needs to be done to fit model output with runoff/soilloss measurement data obtained in rainfall simulations in field.
In previous works these parameters were determined manually with the hillslope erosion modelling tool EROSION-2D [@routschek; @SChindewol].
Both tools share basic algorithms, but show differences in available model options and possible input accuracy of parameters.

For fully reproducable determination, synthetic landuse and Digital Elevation Models (DEM) are used to model rainfall simulation plots in EROSION-3D.
Multiple indepentend plots - identical in relief but differing in target calibration parameter - are calculated simoultanesly.
Relevant model output is analyzed and used to iterate calibration parameter values, until a certain accuracy is reached.

## fitting targets skinfactor

Skinfactor is a calibration parameter to saturated hydraulic conductivity in infiltration submodule in EROSION-3D.
It can be fitted to cumulative runoff from the plot or to an infiltration rate at a certain timestep.

### cumulative runoff

To fit calculated to measured cumulative runoff for an experiment on a soil with

 - 30 Mass-% Clay **Cl**
 - 40 Mass-% Silt **Si**
 - 30 Mass-% Sand **Sa**
 (Clay+Silt+Sand must equal 100 Mass-%)

 - 1.3 Mass-% - Content of organic bound carbon **Corg**
 - 1300 kg/m^3 dry bulk density **Bulk**
 - 22 Vol-% intitial soil moisture at start of experiment **Moist**

which produced

 - 100 litres total runoff **CumRunoff** after 30 minutes **endmin**

with experimental settings of

 - 0.5 mm/h rainfall intensity **intensity**
 - 1 metre wide plot **plotwidth**
 - 10 metre long plot **plotlength**
 - 10 percent slope inclination **slope**
 
with model option

 - limitation of potential infiltration to available water **ponding**
 - output of calibration parameter values for each iteration step **silent**

the skinfactor can be determined by:
```{r}
toolbox.e3d::determine.skin.runoff.E3D(Cl = 30, Si = 40, Sa = 30,
                          Corg = 1.3, Bulk = 1300, Moist = 22,
                          CumRunoff = 100, intensity = 0.5,
                          plotwidth = 1, plotlength = 10,
                          slope = 10,
                          endmin = 30,
                          ponding = TRUE, silent = FALSE)
```

### infiltration rate

using the same values as in the preceeding example
with a differing fitting target of:

- 0.2 mm/min infiltration rate **infilrate** after 30 minutes **endmin**

the skinfactor can be determined by:
```{r}
toolbox.e3d::determine.skin.infil.E3D(Cl = 30, Si = 40, Sa = 30,
                         Corg = 1.3, Bulk = 1300, Moist = 22,
                         infilrate = 0.2, intensity = 0.5,
                         plotwidth = 1, plotlength = 10,
                         slope = 10,
                         endmin = 30,
                         ponding = TRUE, silent = FALSE)
```


## fitting targets resistance to erosion




# validation modelling

## model setup

As first step folders are created including a basic EROSION-3D model.
```{r, eval = FALSE}
toolbox.e3d::create_folders.E3D(path = "C:/E3Dmodel/")
```

### elevation and landuse model

EROSION-3D uses a relief set, derived from a Digital Elevation Model (DEM).
The relief set can be created with

```{r, eval = FALSE}
toolbox.e3d::write.relief.E3D(POLY_ID = c(1,2,3),length = 50,slope = 11, path = "C:/E3Dmodel/", filename = "dem.asc", resolution = 1)

system2("e3d", paste0('/r "',normalizePath(file.path(path,"model/run.par")),'"'), wait=TRUE)
```







